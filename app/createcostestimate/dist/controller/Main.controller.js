sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/core/BusyIndicator","sap/ui/table/Column","sap/m/Label","sap/m/Text","sap/m/MessageToast","re/fin/createcostestimate/model/formatter"],(e,t,a,i,s,r,n,o,l,g,d,c,h)=>{"use strict";return e.extend("re.fin.createcostestimate.controller.Main",{formatter:h,onInit(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("RouteMain").attachPatternMatched(this.onRouteMatched,this)},async onRouteMatched(e){await this.setDefaultData();const t=(new Date).getMonth()+1;const i=new Date((new Date).getFullYear(),(new Date).getMonth()+1,0);var s={costingFromDate:(new Date).getDate()+"/"+t+"/"+(new Date).getFullYear(),costingToDate:i.getDate()+"/"+t+"/"+i.getFullYear()};var r=new a(s);this.getView().setModel(r,"CreateModel");let n=new a;this.getView().setModel(n,"ProgressModel");this.getView().byId("refin-idRefresh").firePress()},async setDefaultData(){o.show();await this.getMaterialData();await this.getPlantData();await this.getErrorMappings();o.hide()},async getErrorMappings(){const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.errorMappingService.uri);try{const t=await fetch(e+"/ErrorRecordSet");const a=await fetch(e+"/MasterConfigSet");if(!t.ok){let e=await t.text();o.hide();n.error(e)}else{const e=await t.json();this.errorMappings=e.value}if(!a.ok){let e=await a.text();o.hide();n.error(e)}else{const e=await a.json();this.masterMappings=e.value}}catch(e){o.hide();n.error("Error while fetching error mapping configurations.")}},async getPlantData(){const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.ZBTP_API_COST_ESTIMATE_SRV.uri);try{const t=await fetch(e+"/zplant_vh_set?$format=json");if(!t.ok){let e=await t.text();o.hide();n.error(e)}else{const e=await t.json();if(e){const t=e.d.results;let i=new a(t);this.getView().setModel(i,"PlantHelp")}}}catch(e){o.hide();n.error("Error while fetching plant data from S/4")}},async getMaterialData(){const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.ZBTP_API_COST_ESTIMATE_SRV.uri);try{const t=await fetch(e+"/zmaterial_vh_type?$format=json");if(!t.ok){let e=await t.text();o.hide();n.error(e)}else{const e=await t.json();if(e){const t=e.d.results;let i=new a(t);this.getView().setModel(i,"MaterialHelp")}}}catch(e){o.hide();n.error("Error while fetching material data from S/4")}},onMaterialReq(e){this.materialInput=e.getSource();var t=this.getView();if(!this.oMaterialPopup){this.oMaterialPopup=i.load({controller:this,name:"re.fin.createcostestimate.view.fragments.MaterialHelp"}).then(function(e){t.addDependent(e);return e})}this.oMaterialPopup.then(function(e){e.open()})},onPlantReq(e){this.plantInput=e.getSource();var t=this.getView();if(!this.oPlantPopup){this.oPlantPopup=i.load({controller:this,name:"re.fin.createcostestimate.view.fragments.PlantHelp"}).then(function(e){t.addDependent(e);return e})}this.oPlantPopup.then(function(e){e.open()})},onMaterialSelect(e){let t=e.getParameter("selectedItem").getBindingContext("MaterialHelp").getObject().matnr;e.getSource().getBinding("items").filter([]);if(!t){return}this.materialInput.setValue(t);if(this.getView().getModel("CreateModel").getData().material===t){let e=this.getView().getModel("MaterialHelp").getData().find(e=>e.matnr===t).maktx;this.getView().byId("refin-idCreateMatDescr").setText(e)}},onPlantSelect(e){let t=e.getParameter("selectedItem").getBindingContext("PlantHelp").getObject().Werks;e.getSource().getBinding("items").filter([]);if(!t){return}this.plantInput.setValue(t);if(this.getView().getModel("CreateModel").getData().plant===t){let e=this.getView().getModel("PlantHelp").getData().find(e=>e.Werks===t).Name;this.getView().byId("refin-idCreatePlantDescr").setText(e)}},onSearchMaterial:function(e){var t=e.getParameter("value");var a=[];if(t){a=[new s([new s("matnr",r.Contains,t),new s("maktx",r.Contains,t)],false)]}e.getSource().getBinding("items").filter(a)},onSearchPlant:function(e){var t=e.getParameter("value");var a=[];if(t){a=[new s([new s("Werks",r.Contains,t),new s("Name",r.Contains,t)],false)]}e.getSource().getBinding("items").filter(a)},onFilterSearch(e){const t=this.getView().getModel("Filter").getData();const a=t.material;const i=t.plant;const s=t.startDate;const r=t.endDate;const n=t.status;var o=this.getView().byId("refin-idMainTable");var l=o.getBinding("items");var g=[]},onLiveSearch(e){var t=e.getParameter("newValue");var a=this.getView().byId("refin-idMainTable");var i=a.getBinding("items");var n=[];if(t){const e=new s("referenceId",r.Contains,t);const a=new s("material",r.Contains,t);const i=new s("plant",r.Contains,t);const o=new s("status",r.Contains,t);const l=new s("materialName",r.Contains,t);const g=new s("plantName",r.Contains,t);const d=new s({filters:[e,a,i,o,l,g]});n.push(d)}i.filter(n);this.setTableProperties()},async onRefresh(e){o.show();const t=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);try{const e=await fetch(t+"/CostEstimateLog?$expand=errorLogs");if(!e.ok){let t=await e.text();o.hide();n.error(t)}else{const t=await e.json();this.cloudRecords=t.value;this.getView().byId("refin-idMainTabTitle").setText(`Cost Estimate Records ( ${this.cloudRecords.length} )`);this.getView().getModel("Records").setData(this.cloudRecords);this.getView().getModel("Records").refresh()}this.setTableProperties();o.hide()}catch(e){o.hide();n.error("Error fetching cost estimate records")}},setTableProperties(){let e=this.getView().byId("refin-idMainTable").getItems();for(let t=0;t<e.length;t++){const a=e[t];switch(a.getCells()[6].getText()){case"Success":a.getCells()[6].setIcon("sap-icon://verified");a.getCells()[6].setState("Success");a.getCells()[7].setVisible(true);break;case"Completed":a.getCells()[6].setIcon("sap-icon://complete");a.getCells()[6].setState("Information");a.getCells()[7].setVisible(false);break;case"Error":a.getCells()[6].setIcon("sap-icon://status-error");a.getCells()[6].setState("Error");a.getCells()[7].setVisible(false);break;case"Submitted":a.getCells()[6].setIcon("sap-icon://in-progress");a.getCells()[6].setState("Warning");a.getCells()[7].setVisible(false);break;case"Cancelled":a.getCells()[6].setIcon("sap-icon://cancel");a.getCells()[6].setState("Indication02");a.getCells()[7].setVisible(false);break;default:break}}},onItemNavigate(e){const t=e.getSource().getBindingContext("Records").sPath.split("/")[1];const a=this.getOwnerComponent().getModel("Records").getData()[t].ID;const i=this.oRouter;i.navTo("RouteErrorDetail",{parentId:a})},onCreateCostEstimate(e){var t=this.getView();if(this.oCreateDialog){this.oCreateDialog=undefined}if(!this.oCreateDialog){this.oCreateDialog=i.load({id:t.getId(),controller:this,name:"re.fin.createcostestimate.view.fragments.CreateDialog"}).then(e=>{t.addDependent(e);return e})}this.oCreateDialog.then(function(e){e.open()})},async onSubmit(e){let t=this.submitPreChecks();if(t){let e=[{executionId:"CREATE-COST-EST",executionCompleted:false,active:false,operation:"Creating Cost Estimate",operationStatus:"Processing"},{executionId:"CLOUD-INSERT-NEW",executionCompleted:false,active:false,operation:"Updating data to cloud",operationStatus:"Pending"}];this.getView().getModel("ProgressModel").setData(e);this.getView().getDependents()[0].destroy();this.showProgressDialog();try{const t=await this.createCostEstimate();e[0].executionCompleted=true;e[0].operationStatus="DONE";e[0].active=false;e[1].operationStatus="Processing";e[1].active=true;this.getView().getModel("ProgressModel").setData(e);this.getView().getModel("ProgressModel").refresh();this.setProgressTabProps();const a="CREATE";const i=await this.activateCloudOperation(a);if(i.ID){const t=i.ID;const s=await this.activateErrorLogOperation(a,t);const r=await Promise.all(s);e[1].executionCompleted=true;e[1].operationStatus="DONE";e[1].active=false;this.getView().getModel("ProgressModel").setData(e);this.getView().getModel("ProgressModel").refresh()}this.setProgressTabProps();this.getView().byId("refin-idCloseProgress").setVisible(true);this.getView().byId("refin-idRefresh").firePress()}catch(t){e[1].executionCompleted=true;e[1].operationStatus="FAILED";e[1].active=false;this.getView().getModel("ProgressModel").setData(e);this.getView().getModel("ProgressModel").refresh();this.setProgressTabProps()}}},activateErrorLogOperation(e,t){var a=[];var i={referenceId:"",parentId:"",errorId:"",type:"",description:"",message:"",assignedDepartment:"",assignedTime:"",assignedOn:"",departmentMail:"",resolutionStatus:"",recentNotif:"",ageingText:""};const s=this.errorMappings.filter(e=>e.plant===this.getView().getModel("CreateModel").getData().plant);for(let e=0;e<s.length;e++){const r=s[e];i={};i.referenceId=jQuery.now().toString();i.parentId=t;i.errorId=r.errorcode;i.type="E";i.description=s.find(e=>e.errorcode===r.errorcode&&e.plant===this.getView().getModel("CreateModel").getData().plant)?.description||"";i.message=i.description;i.assignedDepartment=s.find(e=>e.errorcode===r.errorcode&&e.plant===this.getView().getModel("CreateModel").getData().plant)?.department||"";if(i.assignedDepartment){let e=(new Date).getMonth()+1;i.assignedOn=new Date;i.departmentMail=this.masterMappings.find(e=>e.department===i.assignedDepartment&&e.plant===this.getView().getModel("CreateModel").getData().plant)?.email||"";i.resolutionStatus="Pending"}else{i.resolutionStatus="Not Assigned"}a.push(i)}const r=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);let n=[];for(let e=0;e<a.length;e++){const t=a[e];let i=new Promise(function(t,i){$.ajax(r+"/ErrorLogs",{type:"POST",contentType:"application/json",data:JSON.stringify(a[e]),success:e=>{t(e)},error:e=>{i(e)}})});n.push(i)}return n},getAgeingText(e){let t=(new Date-new Date(e))/(1e3*60*60*24);if(t>=1){var a=Math.round(t)+" days"}else{t=(new Date-new Date(e))/(1e3*60*60);if(t>=1){a=Math.round(t)+" hours"}else{t=(new Date-new Date(e))/(1e3*60);if(t>=1){a=Math.round(t)+" minutes"}else{t=(new Date-new Date(e))/1e3;a=Math.ceil(t)+" seconds"}}}return a},setProgressTabProps(){let e=this.getView().getModel("ProgressModel").getData();const t=this.getView().byId("refin-idProgressTable").getItems();for(let a=0;a<t.length;a++){let i=t[a];if(e[a].executionCompleted){i.getCells()[1].removeStyleClass("mySpinningIcon");i.getCells()[1].setIcon("");if(e[a].operationStatus==="DONE"){i.getCells()[1].setState("Success")}else if(e[a].operationStatus==="FAILED"){i.getCells()[1].setState("Error")}}else{if(e[a].active){i.getCells()[1].setIcon("sap-icon://synchronize");i.getCells()[1].addStyleClass("mySpinningIcon");i.getCells()[1].setState("Warning")}else{i.getCells()[1].setIcon("");i.getCells()[1].setState("None")}}}},activateCloudOperation(e){const t=(new Date).getMonth()+1;const a=new Date((new Date).getFullYear(),(new Date).getMonth()+1,0);let i={referenceId:jQuery.now().toString(),material:this.getView().getModel("CreateModel").getData().material,materialName:this.getView().getModel("CreateModel").getData().materialName,plant:this.getView().getModel("CreateModel").getData().plant,plantName:this.getView().getModel("CreateModel").getData().plantName,costingFromDate:(new Date).getDate()+"/"+t+"/"+(new Date).getFullYear(),costingToDate:a.getDate()+"/"+t+"/"+a.getFullYear(),status:"Error",systemStatus:"SUCCESS",noOfErrors:4};const s=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);return new Promise(function(e,t){$.ajax(s+"/CostEstimateLog",{type:"POST",contentType:"application/json",data:JSON.stringify(i),success:t=>{e(t)},error:e=>{t(e)}})})},async createCostEstimate(e){return new Promise(e=>setTimeout(e,3e3))},submitPreChecks(){let e=this.checkMandatoryFields();let t=this.validateInputCheck();if(!e&&!t){return true}else{return false}},onProgressDialogClose(e){e.getSource().getParent().getParent().destroy()},showProgressDialog(){var e=this.getView();if(this.oProgressDialog){this.oProgressDialog=undefined}if(!this.oProgressDialog){this.oProgressDialog=i.load({id:e.getId(),controller:this,name:"re.fin.createcostestimate.view.fragments.ProgressDialog"}).then(t=>{e.addDependent(t);return t})}this.oProgressDialog.then(function(e){const t=e.getAggregation("content")[0].getItems();e.getAggregation("content")[0].removeSelections(true);for(let e=0;e<t.length;e++){let a=t[e];if(e===0){a.getCells()[1].addStyleClass("mySpinningIcon");a.getCells()[1].setIcon("sap-icon://synchronize");a.getCells()[1].setState("Warning")}else{a.getCells()[1].setIcon("");a.getCells()[1].setState("None")}}e.open()})},validateInputCheck(){let e=false;let t=this.getView().getModel("CreateModel").getData().material;let a=this.getView().getModel("CreateModel").getData().plant;const i=this.getView().getModel("MaterialHelp").getData().some(e=>e.matnr===t);const s=this.getView().getModel("PlantHelp").getData().some(e=>e.Werks===a);if(i&&s){e=false}else{e=true;if(!i){this.getView().byId("refin-idCreateMaterial").setValueState("Error");this.getView().byId("refin-idCreateMaterial").setValueStateText("Material doesn't exist")}else{this.getView().byId("refin-idCreateMaterial").setValueState("None");this.getView().byId("refin-idCreateMaterial").setValueStateText("")}if(!s){this.getView().byId("refin-idCreatePlant").setValueState("Error");this.getView().byId("refin-idCreatePlant").setValueStateText("Plant doesn't exists")}else{this.getView().byId("refin-idCreatePlant").setValueState("None");this.getView().byId("refin-idCreatePlant").setValueStateText("")}}return e},checkMandatoryFields(){let e=false;if(!this.getView().byId("refin-idCreateMaterial").getValue()){this.getView().byId("refin-idCreateMaterial").setValueState("Error");this.getView().byId("refin-idCreateMaterial").setValueStateText("Material is required");e=true}else{this.getView().byId("refin-idCreateMaterial").setValueState("None");this.getView().byId("refin-idCreateMaterial").setValueStateText("");e=false}if(!this.getView().byId("refin-idCreatePlant").getValue()){this.getView().byId("refin-idCreatePlant").setValueState("Error");this.getView().byId("refin-idCreatePlant").setValueStateText("Plant is required");e=true}else{this.getView().byId("refin-idCreatePlant").setValueState("None");this.getView().byId("refin-idCreatePlant").setValueStateText("");e=false}return e},onCancelDialog(e){e.getSource().getParent().getParent().destroy()}})});
//# sourceMappingURL=Main.controller.js.map