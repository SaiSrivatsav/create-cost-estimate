sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel","sap/m/MessageBox"],(e,t,a,r)=>{"use strict";return e.extend("re.fin.createcostestimate.controller.RouteErrorDetail",{onInit(){this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.getRoute("RouteErrorDetail").attachPatternMatched(this.onRouteMatched,this)},onRouteMatched:function(e){this.parentId=e.getParameter("arguments").parentId;this.mainData=this.getOwnerComponent().getModel("Records").getData().find(e=>e.ID===this.parentId);this.setPageData(e)},getAgeingText(e){let t=(new Date-new Date(e))/(1e3*60*60*24);if(t>=1){var a=Math.round(t)+" days"}else{t=(new Date-new Date(e))/(1e3*60*60);if(t>=1){a=Math.round(t)+" hours"}else{t=(new Date-new Date(e))/(1e3*60);if(t>=1){a=Math.round(t)+" minutes"}else{t=(new Date-new Date(e))/1e3;a=Math.ceil(t)+" seconds"}}}return a},setPageData:async function(e){this.getView().byId("refin-titleHdrExp").setText(this.mainData.referenceId);this.getView().byId("refin-titleHdrSnap").setText(this.mainData.referenceId);this.getView().byId("refin-idMatObjHdr").setText(`${this.mainData.material} (${this.mainData.materialName})`);this.getView().byId("refin-idPlantObjHdr").setText(`${this.mainData.plant} (${this.mainData.plantName})`);const t=new Date(this.mainData.createdAt).getMonth()+1;const r=new Date(this.mainData.createdAt).getDate()+"/"+t+"/"+new Date(this.mainData.createdAt).getFullYear();this.getView().byId("refin-idCreationDateHdr").setText(r);this.getView().byId("refin-idAgeingHdr").setText(this.getAgeingText(this.mainData.createdAt));const n=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);const i=this.mainData.errorLogs;let s=new a(i);for(let e=0;e<i.length;e++){const t=i[e];if(t.assignedDepartment){let e=new Date(t.assignedOn);let a=e.getMonth()+1;t.ageingText=this.getAgeingText(e);t.assignedOn=e.getDate()+"/"+a+"/"+e.getFullYear()}else{t.ageingText="";t.assignedDate=""}}this.getView().setModel(s,"ErrorRecords");this.getView().getModel("ErrorRecords").refresh();this.setTableProps()},async onMainRefresh(e){t.show();await this.getErrorMappings();for(let e=0;e<this.getView().getModel("ErrorRecords").getData().length;e++){var a=this.getView().getModel("ErrorRecords").getData()[e];if(!a.assignedDepartment){a.assignedDepartment=this.errorMappings.find(e=>e.errorcode===a.errorId&&e.plant===this.mainData.plant)?.department||"";a.message=this.errorMappings.find(e=>e.errorcode===a.errorId&&e.plant===this.mainData.plant)?.description||"";a.assignedOn=new Date;a.departmentMail=this.masterMappings.find(e=>e.department===a.assignedDepartment&&e.plant===this.mainData.plant)?.email||"";a.resolutionStatus="Pending"}}this.getView().getModel("ErrorRecords").refresh();await this.updateErrorLogs();this.setTableProps();t.hide()},setTableProps(){let e=this.getView().getModel("ErrorRecords").getData()},async updateErrorLogs(){var e=[];var a={referenceId:"",parentId:"",errorId:"",type:"",description:"",message:"",assignedDepartment:"",assignedTime:"",assignedOn:"",departmentMail:"",resolutionStatus:"",recentNotif:""};let n=this.getView().getModel("ErrorRecords").getData();const i=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);let s=[];for(let e=0;e<n.length;e++){const t=n[e];a={};a.referenceId=t.referenceId;a.parentId=t.parentId;a.errorId=t.errorId;a.type=t.type;a.description=t.description;a.message=t.message;a.assignedDepartment=t.assignedDepartment;a.assignedOn=t.assignedOn;a.departmentMail=t.departmentMail;a.resolutionStatus=t.resolutionStatus;a.recentNotif=t.recentNotif;let r=new Promise(function(e,r){$.ajax(i+"/ErrorLogs/"+t.ID,{type:"PUT",contentType:"application/json",data:JSON.stringify(a),success:t=>{e(t)},error:e=>{r(e)}})});s.push(r)}try{const e=await Promise.all(s)}catch(e){t.hide();r.error("Error while updating error logs")}},async getErrorMappings(){const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.errorMappingService.uri);try{const a=await fetch(e+"/ErrorRecordSet");const n=await fetch(e+"/MasterConfigSet");if(!a.ok){let e=await a.text();t.hide();r.error(e)}else{const e=await a.json();this.errorMappings=e.value}if(!n.ok){let e=await n.text();t.hide();r.error(e)}else{const e=await n.json();this.masterMappings=e.value}}catch(e){t.hide();r.error("Error while fetching error mapping configurations.")}},onNavBack(e){const t=this.oRouter;t.navTo("RouteMain")}})});
//# sourceMappingURL=ErrorDetail.controller.js.map